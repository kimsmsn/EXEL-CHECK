<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ì—‘ì…€ DATA TOOL</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet" />
  <style>
    body {
      font-family: 'Roboto', sans-serif;
      padding: 40px;
      background-color: #f5f7fa;
    }
    .container {
      background: white;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      max-width: 700px;
      margin: auto;
    }
    h2 {
      margin-bottom: 20px;
      color: #333;
      font-size: 24px;
    }
    label {
      font-weight: bold;
      margin-right: 10px;
    }
    input[type="text"] {
      padding: 5px 8px;
      border-radius: 4px;
      border: 1px solid #ccc;
      margin-bottom: 15px;
      margin-right: 15px;
    }
    .drop-zone {
      border: 2px dashed #4a90e2;
      padding: 30px;
      text-align: center;
      color: #4a90e2;
      margin-bottom: 15px;
      border-radius: 8px;
      cursor: pointer;
    }
    .drop-zone.dragover {
      background-color: #eaf3fc;
    }
    button {
      padding: 10px 20px;
      border: none;
      background-color: #4a90e2;
      color: white;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      margin-top: 10px;
      margin-right: 5px;
    }
    button:hover {
      background-color: #357ABD;
    }
    #progressContainer {
      margin-top: 15px;
      height: 16px;
      background: #e0e0e0;
      border-radius: 8px;
      overflow: hidden;
      display: none;
    }
    #progressBar {
      height: 100%;
      width: 0%;
      background: #4a90e2;
      transition: width 0.3s;
    }
    .summary {
      margin-top: 20px;
      padding: 10px 15px;
      background-color: #f9f9f9;
      border-left: 4px solid #4a90e2;
      color: #333;
      border-radius: 4px;
    }
    .error-box {
      background: #ffecec;
      color: #c00;
      border-left: 4px solid #c00;
      padding: 10px 15px;
      margin-top: 10px;
      border-radius: 4px;
    }
    .success {
      color: green;
      font-weight: bold;
      margin-top: 15px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>ì—‘ì…€ DATA TOOL</h2>

    <div style="margin-bottom: 20px;">
      <label for="campaignType">ìº í˜ì¸ íƒ€ì…:</label>
      <input type="text" id="campaignType" placeholder="ì˜ˆ: NPN0" />
      <label for="campaignId">ì•„ì´ë””:</label>
      <input type="text" id="campaignId" placeholder="ì˜ˆ: JAMONGLAB" />
    </div>

    <div id="dropZone" class="drop-zone">
      ğŸ“‚ ì—‘ì…€ íŒŒì¼ì„ ì—¬ê¸°ì— ë“œë˜ê·¸ ì•¤ ë“œë¡­ í•˜ê±°ë‚˜ í´ë¦­í•˜ì—¬ ì„ íƒí•˜ì„¸ìš”.
      <input type="file" id="fileInput" style="display: none;" />
    </div>

    <button id="resetBtn">ë¦¬ì…‹</button>
    <button id="recheckBtn" style="display:none;">ë‹¤ì‹œ ê²€ì‚¬</button>
    <button id="downloadBtn" style="display:none;">ì˜¤ë¥˜ ê²°ê³¼ ë‹¤ìš´ë¡œë“œ</button>
    <div id="progressContainer"><div id="progressBar"></div></div>
    <div id="result"></div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script>
    let allErrors = [];
    let fileB5Value = '';
    let cachedData = [];
    const fileInput = document.getElementById('fileInput');
    const dropZone = document.getElementById('dropZone');
    const resetBtn = document.getElementById('resetBtn');
    const recheckBtn = document.getElementById('recheckBtn');
    const downloadBtn = document.getElementById('downloadBtn');
    const resultDiv = document.getElementById('result');
    const progressBar = document.getElementById('progressBar');
    const progressContainer = document.getElementById('progressContainer');
    const campaignTypeInput = document.getElementById('campaignType');
    const campaignIdInput = document.getElementById('campaignId');

    function resetUI() {
      fileInput.value = '';
      resultDiv.innerHTML = '';
      progressBar.style.width = '0%';
      progressContainer.style.display = 'none';
      downloadBtn.style.display = 'none';
      recheckBtn.style.display = 'none';
      fileB5Value = '';
      cachedData = [];
      campaignTypeInput.value = '';
      campaignIdInput.value = '';
    }

    resetBtn.onclick = resetUI;
    recheckBtn.onclick = () => {
      if (cachedData.length > 0) {
        runValidation(cachedData);
      }
    };

    dropZone.onclick = () => fileInput.click();
    dropZone.ondragover = e => { e.preventDefault(); dropZone.classList.add('dragover'); };
    dropZone.ondragleave = () => dropZone.classList.remove('dragover');
    dropZone.ondrop = e => {
      e.preventDefault();
      dropZone.classList.remove('dragover');
      handleFile(e.dataTransfer.files[0]);
    };
    fileInput.onchange = () => handleFile(fileInput.files[0]);

    async function handleFile(file) {
      if (!file) return;

      const campaignType = campaignTypeInput.value.trim();
      const campaignId = campaignIdInput.value.trim();
      if (!campaignType || !campaignId) {
        alert('ìº í˜ì¸ íƒ€ì…ê³¼ ì•„ì´ë””ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }

      const arrayBuffer = await file.arrayBuffer();
      const workbook = XLSX.read(arrayBuffer, { type: 'array' });
      const sheetName = workbook.SheetNames[0];
      const worksheet = workbook.Sheets[sheetName];
      const data = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

      fileB5Value = (data[4] && data[4][1]) ? String(data[4][1]).trim() : '';
      cachedData = data;
      resultDiv.innerHTML = `ğŸ” ê²€ì‚¬ ì‹œì‘: <b>${file.name}</b>`;
      runValidation(data);
    }

    async function runValidation(data) {
      const campaignType = campaignTypeInput.value.trim();
      const campaignId = campaignIdInput.value.trim();

      allErrors = [];
      const total = data.length;
      progressBar.style.width = '0%';
      progressContainer.style.display = 'block';

      for (let i = 4; i < total; i++) {
        const row = data[i];
        const rowId = (row[1] || '').toString().trim();
        const rowType = (row[2] || '').toString().trim();

        if (!rowId && !rowType) continue;

        if (rowId !== campaignId) {
          allErrors.push(`${i + 1}í–‰ ì•„ì´ë”” ì˜¤ë¥˜: '${rowId}' â†’ '${campaignId}'ì™€ ë‹¤ë¦„`);
        }
        if (rowType !== campaignType) {
          allErrors.push(`${i + 1}í–‰ ìº í˜ì¸íƒ€ì… ì˜¤ë¥˜: '${rowType}' â†’ '${campaignType}'ì™€ ë‹¤ë¦„`);
        }

        if (i % 10 === 0) {
          const percent = Math.round((i / total) * 100);
          progressBar.style.width = `${percent}%`;
          resultDiv.innerHTML = `ğŸ“Š ì§„í–‰ ì¤‘... (${i}/${total}í–‰)`;
          await new Promise(resolve => setTimeout(resolve, 0));
        }
      }

      progressBar.style.width = '100%';
      recheckBtn.style.display = 'inline-block';
      displayResult(allErrors);
    }

    function displayResult(errors) {
      if (errors.length === 0) {
        resultDiv.innerHTML = `<div class="success">âœ… ì˜¤ë¥˜ ì—†ìŒ</div>`;
        return;
      }

      const summaryMap = {};
      errors.forEach(err => {
        const key = err.split(':')[1]?.trim().split(' ')[0] || 'ê¸°íƒ€';
        summaryMap[key] = (summaryMap[key] || 0) + 1;
      });

      const summary = Object.entries(summaryMap)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 3)
        .map(([key, count]) => `â€¢ ${key} ê´€ë ¨ ${count}ê±´`)
        .join('<br>');

      const summaryHTML = `
        <div class="summary">
          ğŸš¨ ì´ ì˜¤ë¥˜ ìˆ˜: ${errors.length}ê±´<br>
          ğŸ“Œ ì£¼ìš” ì˜¤ë¥˜:<br>${summary}
        </div>
      `;

      const errorHTML = errors.map(e => `<div class="error-box">âŒ ${e}</div>`).join('');
      resultDiv.innerHTML = summaryHTML + errorHTML;
      downloadBtn.style.display = 'inline-block';
    }

    downloadBtn.onclick = () => {
      const worksheet = XLSX.utils.aoa_to_sheet([['ì˜¤ë¥˜ ë©”ì‹œì§€'], ...allErrors.map(e => [e])]);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, worksheet, 'ì˜¤ë¥˜ê²°ê³¼');

      const today = new Date();
      const y = today.getFullYear();
      const m = ('0' + (today.getMonth() + 1)).slice(-2);
      const d = ('0' + today.getDate()).slice(-2);
      const filename = `${y}-${m}-${d}_ì˜¤ë¥˜ê²°ê³¼_${fileB5Value || 'íŒŒì¼ëª…ë¯¸ì •'}.xlsx`;

      XLSX.writeFile(wb, filename);
    };
  </script>
</body>
</html>
